---
title: "Lab 12 - Accessing NEON Metadata for Metagenomics"
author: "Daniel Hu"
format:
  html:
    toc: true
    toc_float: true
    embed-resources: true
execute: 
  warning: false
  message: false
---

# Why Store Multiple Data Frames in a Single Object in R?
## 1. Better Organization and Readability
## 2. Simplifies Iterative Operations
## 3. Dynamic Handling of Data
## 4. Facilitates Automation and Reproducibility
## 5. Supports Complex Workflows
## 6. Reduces Risk of Errors

# RDS Files
## Saving R Objects as RDS Files
```{r}
#To save an R object as an RDS file, you can use the saveRDS() function. Here’s how it works:
#saveRDS(object, file = "filename.rds")

saveRDS(mtcars, "mtcars.rds")
```

## Reading RDS Files
```{r}
#object <- readRDS(file = "filename.rds")

my_data <- readRDS("mtcars.rds")
```

![Comparison with Other Formats](formatcomparison.png)
# Accessing NEON data
## Load Libararies
```{r}
library(neonUtilities)
library(tidyverse)
library(lubridate)
library(DT)
library(viridis)
```

## Download the NEON soil chemistry data
```{r}
#soilChem <- loadByProduct(
#  dpID='DP1.10086.001',
#  startdate = "2023-01",
#  enddate = "2023-12",
#  check.size = FALSE,
#  package='expanded')
soilChem <- readRDS("/work/pi_bio678_umass_edu/data_NEON/soilChem.rds")
```

```{r}
soilChem$sls_metagenomicsPooling[5,'genomicsSampleID']

soilChem$sls_metagenomicsPooling[5,'collectDate']

soilChem$sls_metagenomicsPooling$genomicsPooledIDList[5]

# View(soilChem$sls_soilChemistry # No soil chemistry data for HARV
soilChem$sls_soilMoisture |> 
  filter(sampleID == "HARV_013-O-39-20230704") |> 
  select(sampleID, soilMoisture)
```

```{r}
# split up the pooled list into new columns
genomicSamples <- soilChem$sls_metagenomicsPooling |>
  tidyr::separate(genomicsPooledIDList, into=c("first","second","third"),sep="\\|",fill="right") |>
  dplyr::select(genomicsSampleID,first,second,third)

head(genomicSamples)
```

```{r}
genSampleExample <- genomicSamples |> 
  tidyr::pivot_longer(cols=c("first","second","third"),values_to = "sampleID") |>
  dplyr::select(sampleID,genomicsSampleID) |>
  drop_na()
```

```{R}
chemEx <- soilChem$sls_soilMoisture |>
  dplyr::select(sampleID,soilMoisture)

## now combine the tables 
combinedTab <- left_join(genSampleExample,chemEx, by = "sampleID") |> drop_na()

## Show the data table
head(combinedTab)
```

# Merging metadata around composite samples
```{r}
genome_groups_mean <- combinedTab %>%
  group_by(genomicsSampleID) %>%
  summarize_at(c("soilMoisture"), mean)

head(genome_groups_mean)
```

# Additional examples for accessing data
## Merging pH measurement
```{r}
soilpH_Example <- soilChem$sls_soilpH %>%
  dplyr::filter(sampleID %in% combinedTab$sampleID) %>%
  dplyr::select(sampleID,soilInWaterpH,soilInCaClpH)

# now join with the existing table
combinedTab_pH <- left_join(combinedTab,soilpH_Example, by = "sampleID")

# and the final
head(combinedTab_pH)
```

```{r}
# Remember to install the respirometry package
library(respirometry)

genome_groups_pH <- combinedTab_pH %>%
  group_by(genomicsSampleID) %>%
  summarize_at(c("soilInWaterpH","soilInCaClpH"), mean_pH) 

head(genome_groups_pH)
```

```{r}
genome_groups_all_mean <- combinedTab_pH %>%
  group_by(genomicsSampleID) %>%
  {left_join(
    summarize_at(.,vars("soilMoisture"), mean),
    summarize_at(.,vars("soilInWaterpH","soilInCaClpH"), mean_pH)
  )}

head(genome_groups_all_mean)
```
 
#Exercises
## Exercise 1
```{r}
# The dataframe sls_soilCoreCollection contains alot of useful information for analyzing the NEON MAGs. Create a new dataframe coreCollectionSubset with just the following columns

#sampleID
#decimalLatitude
#decimalLongitude
#elevation
#soilTemp

coreCollectionSubset <- soilChem$sls_soilCoreCollection %>%
  dplyr::select(
    sampleID,
    decimalLatitude,
    decimalLongitude,
    elevation,
    soilTemp
  )

glimpse(coreCollectionSubset)

```

## Exercise 2 
```{r}
#Following the above examples with chemEx join genSampleExample and coreCollectionSubset.
coreCombinedTab <- genSampleExample |>
  left_join(chemEx, by = "sampleID") |>
  left_join(coreCollectionSubset, by = "sampleID") |>
  drop_na()
```

## Exercise 3
```{r}
#Get the mean for each mean for each metagenome genomicsSampleID for each column in your data frame from Ex. 2.

core_groups_mean <- coreCombinedTab %>%
  # Group the data by the metagenome ID
  group_by(genomicsSampleID) %>%
  # Calculate the mean for every numeric column (excluding the grouping column)
  # .names creates new column names like 'mean_soilMoisture'
  summarize(
    across(where(is.numeric),
           .fns = mean,
           .names = "mean_{.col}"),
    .groups = 'drop' # Drop the grouping structure after summarizing
  )

# View the first few rows of the new summarized data frame
head(core_groups_mean)
```

## Exercise 4
```{r}
#Join the data frame from Ex. 3 with the soil moisture and pH measurments in genome_groups_all_mean.

final_combined_mean <- core_groups_mean %>%
    # Join with the previously calculated means for soil moisture and pH
    left_join(genome_groups_all_mean, by = "genomicsSampleID")

# View the structure of the new, combined data frame
glimpse(final_combined_mean)
```

## Exercise 5
```{r}
#Using the genomicsSampleID column, make a new column with the siteID (e.g. HARV). There is a similar example in lab 6 where we parsed the NEON MAG data.

final_combined_mean <- final_combined_mean %>%
  # Create a new column 'siteID'
  mutate(
    # Extract the site ID using string manipulation:
    # str_sub(string, start, end) extracts a substring.
    siteID = stringr::str_sub(genomicsSampleID, start = 1, end = 4)
    
    # Alternative using regular expression (another common method):
    # siteID = stringr::str_extract(genomicsSampleID, "^[A-Z]{4}")
  )

# View the new column to confirm the extraction
glimpse(final_combined_mean)
head(final_combined_mean)
```

## Exercise 6
```{r}
#Make a box plot with the soilpH by siteID

# Make a box plot with the soilpH by siteID
library(ggplot2) # Ensure ggplot2 is loaded (it's part of tidyverse)

soilpH_boxplot <- final_combined_mean %>%
  # Start the plot, mapping siteID to the x-axis and soilInWaterpH to the y-axis
  ggplot(aes(x = siteID, y = soilInWaterpH)) +
  # Add the box plot geometry
  geom_boxplot() +
  # Add individual points to see the distribution
  geom_point(alpha = 0.5, position = position_jitter(width = 0.1)) +
  # Customize labels for clarity
  labs(
    title = "Soil pH (in water) Distribution by NEON Site",
    x = "NEON Site ID",
    y = "Soil pH (in Water)"
  ) +
  # Use a clean theme
  theme_bw()

# Print the plot
print(soilpH_boxplot)
```

## Exercise 7
```{r}
#Calculate the mean soilTemp and soilMoisture for each siteID. Make a graph of mean soilTemp vs soilMoisture

## Part 1: Calculate mean per siteID
site_means <- final_combined_mean %>%
  # Group the data by the newly created siteID
  group_by(siteID) %>%
  # Calculate the mean of the temperature and moisture means
  summarize(
    avg_soilTemp = mean(mean_soilTemp, na.rm = TRUE),
    avg_soilMoisture = mean(mean_soilMoisture, na.rm = TRUE),
    .groups = 'drop'
  )

# View the resulting table
head(site_means)

## Part 2: Make a graph of mean soilTemp vs soilMoisture
library(ggplot2) # Ensure ggplot2 is loaded

soil_plot <- site_means %>%
  ggplot(aes(x = avg_soilTemp, y = avg_soilMoisture, color = siteID)) +
  # Use points for the scatter plot
  geom_point(size = 3) +
  # Add the siteID as a label next to the point
  geom_text(aes(label = siteID), vjust = -1, check_overlap = TRUE) +
  # Customize labels
  labs(
    title = "Average Soil Moisture vs. Average Soil Temperature by NEON Site",
    x = "Average Soil Temperature (°C)",
    y = "Average Soil Moisture"
  ) +
  # Use a clean theme and remove the legend (since siteID is already labeled)
  theme_bw() +
  theme(legend.position = "none")

# Print the plot
print(soil_plot)
```

## Exercise 8
```{r}
#Join your data frame from Ex 4 with the NEON_MAGs_soil data frame from lab 6.

# 1. Load and process the initial NEON MAGs data (NEON_MAGs_prelim)
NEON_MAGs_prelim <- read_tsv("/work/pi_bio678_umass_edu/data_NEON/exported_img_bins_Gs0166454_NEON.tsv") |>
    janitor::clean_names() |>
    # ... [Rest of the processing/mutations from Lab 6, Block 1] ...
    # Simplified version for necessary steps:
    mutate(
        type = case_when(
            str_detect(genome_name, "Soil microbial communities") ~ "Soil",
            TRUE ~ "Freshwater" # Simplified, as we only need Soil vs. Freshwater
        )
    ) |>
    mutate_at("genome_name", str_replace, "Soil microbial communities from ", "") |>
    separate(genome_name, c("site", "sample_name"), " - ") |>
    separate(gtdb_taxonomy_lineage, c("domain", "phylum", "class", "order", "family", "genus"), "; ", remove = FALSE)

# 2. Create NEON_MAGs_soil (From Lab 6, Soil Block)
NEON_MAGs_soil <- NEON_MAGs_prelim |>
    filter(type == "Soil") |> # Filters for only soil MAGs [cite: 33]
    # separate the Sample Name into Site ID and plot info [cite: 33]
    separate(sample_name, c("site_ID", "subplot.layer.date"), "_", remove = FALSE) |>
    # ... [Insert the rest of the parsing/extract code for soil sample names] ...
    select(-subplot.layer.date)

# Step 1: Prepare NEON_MAGs_soil (rename for joining)
NEON_MAGs_soil <- NEON_MAGs_soil %>%
    rename(genomicsSampleID = sample_name)

# Step 2: Perform the join
final_combined_mag_data <- final_combined_mean %>%
    left_join(NEON_MAGs_soil, by = "genomicsSampleID")

# Confirm the join
glimpse(final_combined_mag_data)
```

## Exercise 9
```{r}
#Make a table of the MAGs found in soils with a pH < 4.0.

acid_soil_mags <- final_combined_mag_data %>%
  # Filter for samples where the mean soil pH is less than 4.0
  filter(soilInWaterpH < 4.0) %>%
  # Select key MAGs and environmental columns for the final table
  select(
    genomicsSampleID,
    siteID,
    soilInWaterpH,
    bin_id,
    # CHANGE THIS LINE from 'completeness' to 'bin_completeness'
    bin_completeness,
    scaffold_count,
    phylum,
    genus
  ) %>%
  # Arrange by the most acidic pH
  arrange(soilInWaterpH)

# View the table of MAGs from highly acidic soils
head(acid_soil_mags)
```

